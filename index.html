<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CRI - Order Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF Invoice -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Day.js for timezone handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <style>
        :root {
            --primary: #2396ef;          /* Soft blue for main accent */
            --primary-dark: #184d72;     /* Deeper blue for contrast */
            --secondary: #f6f7f9;        /* Very light gray for secondary background */
            --background: #f3f6fb;       /* Gentle light blue/gray for main background */
            --background-dark: #233043;  /* Muted dark blue for footer/dark areas */
            --text: #2c3e50;             /* Soft dark gray for text */
            --border: #d1dbe6;           /* Light gray for borders */
            --radius: 12px;
            --shadow: 0 3px 12px rgba(44, 62, 80, 0.08);
            --font: 'Inter', sans-serif;
            --warning-pending: #ffefd5;      /* Pale orange for pending */
            --warning-cooking: #ffe9b3;      /* Soft yellow for cooking */
            --warning-ready: #c1f7ed;        /* Pale teal for ready */
            --warning-completed: #d4f1c5;    /* Light green for completed */
            --nav-active: #e3f0fc;           /* Very soft blue for nav */
            --action-btn: #23b4a7;           /* Teal for action buttons */
            --action-btn-hover: #1d8a7b;     /* Darker teal for hover */
            --action-btn-pop-bg: #f6f7f9;
            --action-btn-pop-border: #23b4a7;
        }
        html, body {
            min-height: 100%;
            margin: 0;
            font-family: var(--font);
            background: var(--background);
            color: var(--text);
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 1.2rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }
        header h1 {
            font-size: 1.6rem;
            margin: 0;
            display: flex;
            align-items: center;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.18s;
            padding: 0.45rem 1.6rem;
            border-radius: var(--radius);
            position: relative;
            box-shadow: none;
            outline: none;
        }
        .nav-btn.active {
            background: var(--nav-active);
            color: var(--primary-dark);
            box-shadow: 0 2px 16px rgba(60,20,20,0.17);
            z-index: 2;
        }
        .nav-btn.active .fa, .nav-btn.active .fas {
            color: var(--primary-dark);
        }
        .container {
            flex: 1;
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            padding: 2rem;
            border: 1px solid var(--border);
        }
        .section-title {
            font-size: 1.32rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--primary-dark);
        }
        .divider {
            height: 1px;
            background: var(--border);
            margin: 2rem 0;
        }
        .form-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.4rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.7rem;
            font-size: 1rem;
            background: #fff;
            outline: none;
            transition: border 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border: 1.5px solid var(--primary);
        }
        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .form-row > .form-group {
            flex: 1;
            min-width: 220px;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:disabled {
            background: #ffb97a;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--secondary);
            color: var(--primary-dark);
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
        }
        th, td {
            padding: 0.9rem 0.6rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--secondary);
            font-weight: 600;
            color: var(--primary-dark);
        }
        tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-pending { background: var(--warning-pending); color: #e65100; border: 2px solid #ffd54f;}
        .status-cooking { background: var(--warning-cooking); color: #1b5e20; border: 2px solid #388e3c;}
        .status-ready { background: var(--warning-ready); color: #01579b; border: 2px solid #1976d2;}
        .status-completed { background: var(--warning-completed); color: #4527a0; border: 2px solid #7e57c2;}
        .order-group-title.pending {background: var(--warning-pending); color: #e65100; padding: 0.4rem 1rem; border-radius: var(--radius);}
        .order-group-title.cooking {background: var(--warning-cooking); color: #1b5e20; padding: 0.4rem 1rem; border-radius: var(--radius);}
        .order-group-title.ready {background: var(--warning-ready); color: #01579b; padding: 0.4rem 1rem; border-radius: var(--radius);}
        .order-group-title.completed {background: var(--warning-completed); color: #4527a0; padding: 0.4rem 1rem; border-radius: var(--radius);}
        .actions {display: flex;gap: 0.6rem;}
        .action-btn {
            background: var(--action-btn);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.7rem 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(60,20,20,0.13);
            position: relative;
            transition: background 0.18s, transform 0.22s;
            outline: none;
            min-width: 120px;
        }
        .action-btn:active,
        .action-btn.pop {
            animation: popAction 0.36s cubic-bezier(.6,-0.28,.74,1.29);
        }
        @keyframes popAction {
            0% { transform: scale(1); background: var(--action-btn);}
            30% { transform: scale(1.08); background: var(--action-btn-hover);}
            75% { transform: scale(0.96); background: var(--action-btn);}
            100% { transform: scale(1); background: var(--action-btn);}
        }
        .action-btn:focus {
            box-shadow: 0 0 0 3px #ffb97a;
        }
        .action-btn:hover {
            background: var(--action-btn-hover);
        }
        .notification {
            position: fixed;
            right: 1.2rem;
            top: 1.2rem;
            background: var(--primary-dark);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 9999;
            font-weight: 600;
            display: none;
        }
        .menu-section {
            display: flex;
            flex-direction: column;
            /* align-items: center; */
        }
        
        .section-title {
            width: 100%;
            text-align: center; /* teks judul di tengah */
            justify-content: center; /* kalau flex, judul di tengah */
            margin-bottom: 0.8rem;
        }
        .menu-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            width: 100%;
        }
        .menu-item {
            background: var(--secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1rem 1.2rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        .menu-item-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }
        .menu-item-price {
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 0.6rem;
        }
        .menu-item-desc {
            font-size: 0.97rem;
            color: #444;
            margin-bottom: 0.4rem;
        }
        .menu-item-select {
            margin-top: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: flex-start;
        }
        .qty-btn {
            font-size: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: #fff;
            font-weight: bold;
            margin: 0 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qty-btn:active, .qty-btn:hover {
            background: var(--primary-dark);
        }
        .menu-item-select span {
            font-size: 1.3rem;
            min-width: 42px;
            display: inline-block;
            text-align: center;
        }
        .footer {
            background: var(--background-dark);
            color: var(--secondary);
            padding: 1.3rem 2rem;
            text-align: center;
            font-size: 1.1rem;
            margin-top: auto;
            border-top: 3px solid var(--primary);
        }
        .footer-buttons {
            margin-top: 1.1rem;
            display: flex;
            justify-content: center;
            gap: 1.8rem;
            flex-wrap: wrap;
        }
        .footer-btn {
            background: var(--secondary);
            color: var(--primary-dark);
            border: none;
            border-radius: var(--radius);
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.18s;
            margin-bottom: 0.3rem;
            outline: none;
            box-shadow: 0 2px 8px rgba(60, 20, 20, 0.09);
        }
        .footer-btn.active {
            background: var(--primary-dark);
            color: white;
            box-shadow: 0 2px 12px rgba(60, 20, 20, 0.15);
        }
        .detailed-list {
            font-size: 0.98rem;
            margin-top: 0.2rem;
            margin-bottom: 0.4rem;
            padding-left: 15px;
        }
        .detailed-list li {
            margin-bottom: 2px;
        }
        .order-group {
            margin-bottom: 3rem;
        }
        .kitchen-order-card {
            background: var(--secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            padding: 0.9rem 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }
        .kitchen-order-details { font-weight: 600; }
        @media (max-width: 900px) {
            .container { padding: 1rem 0.5rem; }
            .card { padding: 1rem; }
            nav { gap: 1rem; }
            .footer-buttons { gap: 0.8rem; }
        }
        @media (max-width: 600px) {
            nav { flex-direction: column; gap: 0.4rem; }
            header { flex-direction: column; align-items: flex-start; gap: 0.7rem; }
            .section-title { font-size: 1.05rem; }
            .container { padding: 0.5rem 0.2rem; }
            .card { padding: 0.5rem; }
            .menu-list { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 0.7rem; }
            table { font-size: 0.92rem; }
            th, td { padding: 0.5rem 0.3rem; }
            .footer { padding: 1rem 0.5rem; font-size: 0.93rem; }
            .notification { padding: 0.7rem 1rem; font-size: 0.97rem; }
            .qty-btn { font-size: 1.4rem; width: 38px; height: 38px; }
            .menu-item-select span { font-size: 1rem; min-width: 32px; }
        }
        @media (max-width: 430px) {
            .section-title { font-size: 0.85rem; }
            .container { padding: 0.1rem 0; }
            .menu-item-title { font-size: 0.99rem; }
            .footer { font-size: 0.85rem; padding: 0.7rem 0.2rem; }
            th, td { font-size: 0.85rem; }
        }
        .collapse { display: none; }
        .show { display: block; }
        .section { display: none; }
        .section.active { display: block; }
        .order-history-log {
            font-size: 0.93rem;
            background: #f7ebd6;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            border: 1px solid #ffdeb0;
        }
        .edit-cancel-btns {
            display: flex;
            gap: 0.4rem;
        }
        .edit-mode-bar {
            background: #ffe1c2;
            border-radius: var(--radius);
            padding: 0.9rem 1.6rem;
            margin-bottom: 1.1rem;
            box-shadow: 0 2px 12px rgba(60,20,20,0.12);
            border: 2px solid #ff6d1a;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.8rem;
        }
        .edit-mode-bar strong {
            color: #e65100;
            font-size: 1.13rem;
        }
        .edit-mode-bar .edit-bar-btns {
            display: flex;
            gap: 0.8rem;
        }
        .floating-bottom-btn {
            position: fixed;
            left: 50%;
            bottom: 38px;
            transform: translateX(-50%);
            z-index: 999;
            box-shadow: 0 4px 24px rgba(60,20,20,0.15);
            padding: 0.85rem 2.3rem;
            font-size: 1.13rem;
        }
        .floating-bottom-btn.hide {
            display: none;
        }
        @media (max-width: 600px) {
            .floating-bottom-btn {
                font-size: 0.97rem;
                padding: 0.7rem 1.3rem;
                bottom: 16px;
            }
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(60,20,20,0.16);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 0 4px 32px rgba(60,20,20,0.20);
            padding: 2rem 2.2rem;
            min-width: 320px;
            max-width: 95vw;
            border: 1.5px solid var(--primary);
        }
        .modal-title {
            font-size: 1.32rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .modal-summary-details {
            font-size: 1.08rem;
            margin-bottom: 1.1rem;
        }
        .modal-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        @media (max-width: 600px) {
            .modal { padding: 1rem 0.7rem; min-width: 220px; }
            .modal-title { font-size: 1.02rem; }
            .modal-summary-details { font-size: 0.97rem; }
            .modal-total { font-size: 1.05rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-title">
            <h1>CRI WEB ORDER</h1>
        </div>
        <nav>
            <button id="nav-admin" class="nav-btn active"><i class="fas fa-user-cog"></i> ADMIN</button>
            <button id="nav-kitchen" class="nav-btn"><i class="fas fa-utensils"></i> DAPUR</button>
        </nav>
    </header>
    <div class="notification" id="notification"></div>
    <!-- MODAL Order Summary -->
    <div class="modal-overlay" id="order-summary-modal">
        <div class="modal">
            <div class="modal-title"><i class="fas fa-file-alt"></i> Konfirmasi Order Sebelum Kirim ke Kitchen</div>
            <div class="modal-summary-details" id="modal-summary-details"></div>
            <div class="modal-total" id="modal-summary-total"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="modal-edit-btn"><i class="fas fa-edit"></i> Edit Order</button>
                <button class="btn" id="modal-send-btn"><i class="fas fa-paper-plane"></i> Kirim ke Kitchen</button>
            </div>
        </div>
    </div>
    <main class="container">
        <!-- Admin Dashboard Section -->
        <section id="admin-section" class="section card active">
            <div class="section-title"><i class="fas fa-user-cog"></i> ADM - INPUT ORDER</div>
            <div id="edit-mode-bar" class="edit-mode-bar" style="display:none;">
                <strong>Edit Order Mode</strong>
                <span>You are editing order <span id="edit-order-id-bar"></span>. Make changes and click "Submit" to save, or "Cancel Edit" to discard changes.</span>
                <div class="edit-bar-btns">
                    <button class="btn" id="edit-order-save-btn">Submit Edit</button>
                    <button class="btn btn-secondary" id="edit-order-cancel-btn">Cancel Edit</button>
                </div>
            </div>
            <form id="order-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">NAMA</label>
                        <input type="text" id="customer-name" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-time">WAKTU ANTAR</label>
                        <input type="time" id="delivery-time" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-location">LOKASI</label>
                        <input type="text" id="delivery-location" required>
                    </div>
                </div>
                <div class="menu-section">
                    <div class="section-title" onclick="toggleMenuSection('packages')" style="cursor:pointer"><i class="fas fa-list"></i> MENU PAKET <span id="package-toggle-icon">[ + ]</span></div>
                    <div class="menu-list" id="package-menu-list"></div>
                </div>
                <div class="menu-section">
                    <div><br></div>
                </div>
                <div class="menu-section">
                    <div class="section-title" onclick="toggleMenuSection('alacarte')" style="cursor:pointer"><i class="fas fa-list"></i> MENU SATUAN <span id="alacarte-toggle-icon">[ + ]</span></div>
                    <div class="menu-list" id="alacarte-menu-list"></div>
                </div>
                <div class="form-group">
                    <label for="order-notes">CATATAN TAMBAHAN</label>
                    <textarea id="order-notes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn" id="send-to-kitchen-btn" style="display:none;">Send to Kitchen</button>
            </form>
            <button type="button" class="btn floating-bottom-btn" id="floating-send-to-kitchen-btn">
                <i class="fas fa-paper-plane"></i> SUBMIT ORDER
            </button>
            <div class="divider"></div>
            <div class="section-title"><i class="fas fa-list"></i> PESANAN DI DAPUR</div>
            <div class="order-group" id="admin-orders-pending">
                <div class="order-group-title pending">BELUM DIMASAK</div>
                <div class="table-responsive">
                    <table id="admin-orders-table-pending">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAMA</th>
                                <th>PESANAN</th>
                                <th>WAKTU ANTAR</th>
                                <th>STATUS</th>
                                <th>HISTORY</th>
                                <th>SET</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="order-group" id="admin-orders-cooking">
                <div class="order-group-title cooking">SEDANG DIMASAK</div>
                <div class="table-responsive">
                    <table id="admin-orders-table-cooking">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAMA</th>
                                <th>PESANAN</th>
                                <th>WAKTU ANTAR</th>
                                <th>STATUS</th>
                                <th>HISTORY</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="order-group" id="admin-orders-ready">
                <div class="order-group-title ready">SIAP DIANTAR</div>
                <div class="table-responsive">
                    <table id="admin-orders-table-ready">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAMA</th>
                                <th>PESANAN</th>
                                <th>WAKTU ANTAR</th>
                                <th>STATUS</th>
                                <th>HISTORY</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="order-group" id="admin-orders-completed">
                <div class="order-group-title completed">DONE!</div>
                <div class="table-responsive">
                    <table id="admin-orders-table-completed">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAMA</th>
                                <th>PESANAN</th>
                                <th>WAKTU ANTAR</th>
                                <th>STATUS</th>
                                <th>HISTORY</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
        <!-- Kitchen Dashboard Section -->
        <section id="kitchen-section" class="section card">
            <div class="section-title"><i class="fas fa-utensils"></i> ORDERAN DAPUR</div>
            <div class="order-group" id="kitchen-orders-pending">
                <div class="order-group-title pending">BELUM DIMASAK</div>
                <div id="kitchen-pending-order-list"></div>
            </div>
            <div class="order-group" id="kitchen-orders-cooking">
                <div class="order-group-title cooking">SEDANG DIMASAK</div>
                <div id="kitchen-cooking-order-list"></div>
            </div>
            <div class="order-group" id="kitchen-orders-ready">
                <div class="order-group-title ready">SIAP DIANTAR</div>
                <div id="kitchen-ready-order-list"></div>
            </div>
            <div class="order-group" id="kitchen-orders-completed">
                <div class="order-group-title completed">DONE!</div>
                <div id="kitchen-completed-order-list"></div>
            </div>
        </section>
        <!-- Reports & Export Section -->
        <section id="reports-section" class="section card">
            <div class="section-title"><i class="fas fa-file-excel"></i> REPORTS</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="report-range">Report Date Range</label>
                    <input type="date" id="report-start"> to
                    <input type="date" id="report-end">
                </div>
                <div class="form-group">
                    <label for="report-type">Report Type</label>
                    <select id="report-type">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
            </div>
            <button class="btn" id="export-excel-btn"><i class="fas fa-file-export"></i> Export to Excel</button>
            <div class="divider"></div>
            <div class="section-title"><i class="fas fa-file-invoice"></i> Generated Invoices</div>
            <div class="table-responsive">
                <table id="invoices-table">
                    <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>ID</th>
                            <th>NAMA</th>
                            <th>Total Price</th>
                            <th>Completed Time</th>
                            <th>Download</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <!-- Menu Management Section -->
        <section id="menu-section" class="section card">
            <div class="section-title"><i class="fas fa-book"></i> ATUR EDIT MENU</div>
            <form id="menu-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="menu-type">Type</label>
                        <select id="menu-type">
                            <option value="package">MENU PAKET</option>
                            <option value="alacarte">MENU SATUAN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="menu-name">NAMA MENU</label>
                        <input type="text" id="menu-name" required>
                    </div>
                    <div class="form-group">
                        <label for="menu-desc">DETAIL</label>
                        <input type="text" id="menu-desc">
                    </div>
                    <div class="form-group">
                        <label for="menu-price">HARGA (¥)</label>
                        <input type="number" min="0" id="menu-price" required>
                    </div>
                </div>
                <button type="submit" class="btn"><i class="fas fa-plus"></i> TAMBAH MENU</button>
            </form>
            <div class="divider"></div>
            <div class="section-title"><i class="fas fa-list"></i> MENU YANG SUDAH ADA</div>
            <div class="table-responsive">
                <table id="menu-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>SET</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>
    <footer class="footer">
        <div class="footer-buttons">
            <button id="footer-reports" class="footer-btn"><i class="fas fa-file-excel"></i> REPORT</button>
            <button id="footer-menu" class="footer-btn"><i class="fas fa-book"></i> ATUR EDIT MENU</button>
        </div>
    </footer>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBoDQI5RgVlDOgYfs4qBIEjJPEBJG_rSJU",
            authDomain: "cita-rasa-indo.firebaseapp.com",
            projectId: "cita-rasa-indo",
            storageBucket: "cita-rasa-indo.firebasestorage.app",
            messagingSenderId: "34181971563",
            appId: "1:34181971563:web:eb1f554ba6bbcc9c797b2e",
            measurementId: "G-N82XGK7SZY"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);

        const DEFAULT_TZ = 'Asia/Bangkok';

        const defaultMenuSeed = [
            {id:"package_payalur_bakwan", type:"package", name:"PAYALUR", desc:"Nasi Putih dan Ayam Goreng + Telur Balado + Bakwan Sayur + Sayur dan Sambal", price:35},
            {id:"package_payalur_kentang", type:"package", name:"PAYALUR", desc:"Nasi Putih dan Ayam Goreng + Telur Balado + Kentang Balado + Sayur dan Sambal", price:35},
            {id:"package_payalit_kentang", type:"package", name:"PAYALIT", desc:"Nasi Putih dan Ayam Goreng + Kentang Balado + Sayur dan Sambal", price:30},
            {id:"package_payalit_bakwan", type:"package", name:"PAYALIT", desc:"Nasi Putih dan Ayam Goreng + Bakwan Sayur + Sayur dan Sambal", price:30},
            {id:"package_payamat", type:"package", name:"PAYAMAT", desc:"Nasi Putih dan Ayam Goreng + Sayur dan Sambal", price:25},
            {id:"package_palutang", type:"package", name:"PALUTANG", desc:"Nasi Putih dan Telur Balado + Kentang Balado + Bakwan Sayur + Sayur", price:25},
            {id:"package_palur", type:"package", name:"PALUR", desc:"Nasi Putih dan Telur Balado + Bakwan Sayur + Sayur", price:20},
            {id:"package_prames_a", type:"package", name:"PRAMES A", desc:"Nasi Putih + Ayam Goreng + Tahu + Timun + Sambal + Kremesan", price:25},
            {id:"package_prames_b", type:"package", name:"PRAMES B", desc:"Nasi Putih + Ayam Goreng + Telur Balado + Tahu + Timun + Sambal + Kremesan", price:33},
            {id:"package_prames_c", type:"package", name:"PRAMES C", desc:"Nasi Putih + Ayam Goreng + Kentang Balado + Tahu + Timun + Sambal + Kremesan", price:30},
            {id:"package_prames_veggie", type:"package", name:"PRAMES VEGGIE", desc:"Nasi Putih + Tahu + Timun + Sambal + Kremesan", price:15},
            {id:"package_prames_karbo", type:"package", name:"PRAMES KARBO", desc:"Nasi Putih + Kentang Balado + Sambal + Kremesan", price:15},
            {id:"alacarte_ayam_goreng", type:"alacarte", name:"Ayam Goreng", desc:"-", price:15},
            {id:"alacarte_telur_balado", type:"alacarte", name:"Telur Balado", desc:"-", price:10},
            {id:"alacarte_bakwan_sayur", type:"alacarte", name:"Bakwan Sayur", desc:"-", price:5},
            {id:"alacarte_kentang_balado", type:"alacarte", name:"Kentang Balado", desc:"-", price:10},
            {id:"alacarte_tahu", type:"alacarte", name:"Tahu", desc:"-", price:5},
        ];
        const menuDetails = {
            'PAYALUR BAKWAN': [
                'Nasi Putih',
                'Ayam Goreng',
                'Telur Balado',
                'Bakwan Sayur',
                'Sayur',
                'Sambal'
            ],
            'PAYALUR KENTANG': [
                'Nasi Putih',
                'Ayam Goreng',
                'Telur Balado',
                'Kentang Balado',
                'Sayur',
                'Sambal'
            ],
            'PAYALIT KENTANG': [
                'Nasi Putih',
                'Ayam Goreng',
                'Kentang Balado',
                'Sayur',
                'Sambal'
            ],
            'PAYALIT BAKWAN': [
                'Nasi Putih',
                'Ayam Goreng',
                'Bakwan Sayur',
                'Sayur',
                'Sambal'
            ],
            'PAYAMAT': [
                'Nasi Putih',
                'Ayam Goreng',
                'Sayur',
                'Sambal'
            ],
            'PALUTANG': [
                'Nasi Putih',
                'Telur Balado',
                'Kentang Balado',
                'Bakwan Sayur',
                'Sayur'
            ],
            'PALUR': [
                'Nasi Putih',
                'Telur Balado',
                'Bakwan Sayur',
                'Sayur'
            ],
            'PRAMES A': [
                'Nasi Putih',
                'Ayam Goreng',
                'Tahu',
                'Timun',
                'Sambal',
                'Kremesan'
            ],
            'PRAMES B': [
                'Nasi Putih',
                'Ayam Goreng',
                'Telur Balado',
                'Tahu',
                'Timun',
                'Sambal',
                'Kremesan'
            ],
            'PRAMES C': [
                'Nasi Putih',
                'Ayam Goreng',
                'Kentang Balado',
                'Tahu',
                'Timun',
                'Sambal',
                'Kremesan'
            ],
            'PRAMES VEGGIE': [
                'Nasi Putih',
                'Tahu',
                'Timun',
                'Sambal',
                'Kremesan'
            ],
            'PRAMES KARBO': [
                'Nasi Putih',
                'Kentang Balado',
                'Sambal',
                'Kremesan'
            ]
        };

        let menuItems = [];
        let orders = [];
        let invoices = [];
        let telegramSentIds = new Set();
        let menuSeeded = false;

        async function seedMenuIfNeeded() {
            const snap = await db.collection('menu').get();
            if (snap.empty) {
                for (const mi of defaultMenuSeed) {
                    await db.collection('menu').doc(mi.id).set(mi);
                }
                menuSeeded = true;
                showNotification("Menu default berhasil di-seed! Silakan refresh di device lain.");
            }
        }
        seedMenuIfNeeded();

        function showNotification(msg, duration = 2500) {
            const notif = document.getElementById('notification');
            notif.innerText = msg;
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', duration);
        }
        function formatStatus(status) {
            switch(status) {
                case "Pending": return `<span class="status-badge status-pending">Pending</span>`;
                case "Cooking": return `<span class="status-badge status-cooking">Cooking</span>`;
                case "Ready": return `<span class="status-badge status-ready">Ready</span>`;
                case "Completed": return `<span class="status-badge status-completed">Completed</span>`;
                default: return status;
            }
        }
        function formatDateTime(ts) {
            if (!ts) return '';
            let d;
            if (ts instanceof Date) {
                d = dayjs(ts);
            } else if (ts && ts.seconds) {
                d = dayjs.unix(ts.seconds);
            } else if (typeof ts === 'string' && ts.includes('T')) {
                d = dayjs(ts);
            } else {
                d = dayjs(ts);
            }
            return d.tz(DEFAULT_TZ).format('YYYY-MM-DD HH:mm');
        }
        function calcOrderTotal(order) {
            let total = 0;
            for (const pkg of order.packages) {
                const mi = menuItems.find(m => m.id === pkg.menuId);
                if (mi) total += mi.price * pkg.qty;
            }
            for (const ac of order.alacarte) {
                const mi = menuItems.find(m => m.id === ac.menuId);
                if (mi) total += mi.price * ac.qty;
            }
            return total;
        }
        function autoFileNameReport(type, start, end) {
            let s = start ? start.replaceAll('-', '_') : '';
            let e = end ? end.replaceAll('-', '_') : '';
            return `report_${type}_${s}_${e}.xlsx`;
        }
        const sections = ['admin-section','kitchen-section','reports-section','menu-section'];
        function showSection(secId) {
            sections.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(secId).classList.add('active');
            window.scrollTo(0,0);
            renderAdminOrders();
            renderKitchenOrders();
            handleFloatingBtnVisibility();
        }
        document.getElementById('nav-admin').onclick = function() {
            showSection('admin-section');
            setNavActive('nav-admin');
        };
        document.getElementById('nav-kitchen').onclick = function() {
            showSection('kitchen-section');
            setNavActive('nav-kitchen');
        };
        document.getElementById('footer-reports').onclick = function() {
            showSection('reports-section');
            setFooterActive('footer-reports');
        };
        document.getElementById('footer-menu').onclick = function() {
            showSection('menu-section');
            setFooterActive('footer-menu');
        };
        function setNavActive(navId) {
            document.getElementById('nav-admin').classList.remove('active');
            document.getElementById('nav-kitchen').classList.remove('active');
            document.getElementById(navId).classList.add('active');
            document.getElementById('footer-reports').classList.remove('active');
            document.getElementById('footer-menu').classList.remove('active');
            handleFloatingBtnVisibility();
        }
        function setFooterActive(footerId) {
            document.getElementById('footer-reports').classList.remove('active');
            document.getElementById('footer-menu').classList.remove('active');
            document.getElementById(footerId).classList.add('active');
            document.getElementById('nav-admin').classList.remove('active');
            document.getElementById('nav-kitchen').classList.remove('active');
            handleFloatingBtnVisibility();
        }

        window.changeQty = function(inputId, delta) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(inputId + '_display');
            let val = Number(input.value);
            val = Math.max(0, val + delta);
            input.value = val;
            display.innerText = val;
        };

        function renderMenus() {
            const pkgList = document.getElementById('package-menu-list');
            const acList = document.getElementById('alacarte-menu-list');
            pkgList.innerHTML = '';
            acList.innerHTML = '';
            for (const mi of menuItems.filter(m => m.type === 'package')) {
                pkgList.innerHTML += `
                    <div class="menu-item">
                        <div class="menu-item-title" onclick="toggleMenuDetails('${mi.id}')" style="cursor:pointer">${mi.name}</div>
                        <div class="menu-item-price">¥${mi.price}</div>
                        <ul class="detailed-list">
                            ${menuDetails[mi.name] ? menuDetails[mi.name].map(i => `<li>${i}</li>`).join('') : ''}
                        </ul>
                        <div class="menu-item-select">
                            <button type="button" class="qty-btn" onclick="changeQty('pkg_${mi.id}_qty', -1)">&#8722;</button>
                            <span id="pkg_${mi.id}_qty_display">0</span>
                            <button type="button" class="qty-btn" onclick="changeQty('pkg_${mi.id}_qty', 1)">&#43;</button>
                            <input type="hidden" id="pkg_${mi.id}_qty" value="0">
                        </div>
                    </div>
                `;
            }
            for (const mi of menuItems.filter(m => m.type === 'alacarte')) {
                acList.innerHTML += `
                    <div class="menu-item">
                        <div class="menu-item-title" onclick="toggleMenuDetails('${mi.id}')" style="cursor:pointer">${mi.name}</div>
                        <div class="menu-item-price">¥${mi.price}</div>
                        <div class="menu-item-desc">${mi.desc}</div>
                        <div class="menu-item-select">
                            <button type="button" class="qty-btn" onclick="changeQty('ac_${mi.id}_qty', -1)">&#8722;</button>
                            <span id="ac_${mi.id}_qty_display">0</span>
                            <button type="button" class="qty-btn" onclick="changeQty('ac_${mi.id}_qty', 1)">&#43;</button>
                            <input type="hidden" id="ac_${mi.id}_qty" value="0">
                        </div>
                    </div>
                `;
            }
        }
        function renderMenuTable() {
            const tb = document.getElementById('menu-table').getElementsByTagName('tbody')[0];
            tb.innerHTML = '';
            for (const mi of menuItems) {
                tb.innerHTML += `<tr>
                    <td>${mi.type.charAt(0).toUpperCase()+mi.type.slice(1)}</td>
                    <td>${mi.name}</td>
                    <td>${mi.desc}</td>
                    <td>¥${mi.price}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="removeMenuItem('${mi.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }
        }
        window.removeMenuItem = async function(id) {
            await db.collection('menu').doc(id).delete();
            showNotification('Menu item removed!');
        };
        window.toggleMenuDetails = function(id) {
            const el = document.getElementById('menu-details-' + id);
            el.classList.toggle('collapse');
            el.classList.toggle('show');
        };
        window.toggleMenuSection = function(section) {
            let listId = section === 'packages' ? 'package-menu-list' : 'alacarte-menu-list';
            let iconId = section === 'packages' ? 'package-toggle-icon' : 'alacarte-toggle-icon';
            const el = document.getElementById(listId);
            const icon = document.getElementById(iconId);
            if (el.classList.contains('collapse')) {
                el.classList.remove('collapse');
                el.classList.add('show');
                icon.textContent = '[ - ]';
            } else {
                el.classList.add('collapse');
                el.classList.remove('show');
                icon.textContent = '[ + ]';
            }
        };
        document.getElementById('menu-form').onsubmit = async function(e) {
            e.preventDefault();
            const type = document.getElementById('menu-type').value;
            const name = document.getElementById('menu-name').value.trim();
            const desc = document.getElementById('menu-desc').value.trim();
            const price = Number(document.getElementById('menu-price').value);
            if (!name || isNaN(price) || price <= 0) return showNotification('Invalid menu item!');
            const id = `${type}_${name.replace(/\s+/g,'_').toLowerCase()}_${Math.floor(Math.random()*100000)}`;
            await db.collection('menu').doc(id).set({id, type, name, desc, price});
            showNotification('Menu item added!');
            document.getElementById('menu-form').reset();
        };

        function renderAdminOrders() {
            renderOrdersTable('admin-orders-table-pending', orders.filter(o=>o.status==='Pending'), true);
            renderOrdersTable('admin-orders-table-cooking', orders.filter(o=>o.status==='Cooking'));
            renderOrdersTable('admin-orders-table-ready', orders.filter(o=>o.status==='Ready'));
            renderOrdersTable('admin-orders-table-completed', orders.filter(o=>o.status==='Completed'), false, true);
        }

        function renderKitchenOrders() {
            renderKitchenOrderCards('kitchen-pending-order-list', orders.filter(o=>o.status==='Pending'));
            renderKitchenOrderCards('kitchen-cooking-order-list', orders.filter(o=>o.status==='Cooking'));
            renderKitchenOrderCards('kitchen-ready-order-list', orders.filter(o=>o.status==='Ready'));
            renderKitchenOrderCards('kitchen-completed-order-list', orders.filter(o=>o.status==='Completed'), true);
        }
        function renderKitchenOrderCards(containerId, orderArr, showInvoice) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const sorted = orderArr.slice().sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
            for (const ord of sorted) {
                container.innerHTML += kitchenOrderCardHtml(ord, showInvoice);
            }
        }
        function kitchenOrderCardHtml(ord, showInvoice) {
            return `
            <div class="kitchen-order-card">
                <div><b>Customer:</b> ${ord.customer}</div>
                <div><b>Details:</b> ${renderOrderDetailsKitchen(ord)}</div>
                <div><b>Notes:</b> ${ord.notes || '-'}</div>
                <div><b>Delivery:</b> ${formatDateTime(ord.deliveryTime)}</div>
                <div><b>Delivery Location:</b> ${ord.deliveryLocation}</div>
                <div><b>Order ID:</b> ${ord.id}</div>
                <div><b>Status:</b> ${formatStatus(ord.status)}</div>
                <div class="kitchen-order-actions">
                    ${ord.status === 'Pending' ? `<button class="action-btn" onclick="handleKitchenAction('${ord.id}','Cooking', this)">Start Cooking</button>` : ''}
                    ${ord.status === 'Cooking' ? `<button class="action-btn" onclick="handleKitchenAction('${ord.id}','Ready', this)">Ready for Delivery</button>` : ''}
                    ${ord.status === 'Ready' ? `<button class="action-btn" onclick="handleKitchenAction('${ord.id}','Completed', this)">Complete Order</button>` : ''}
                    ${showInvoice ? `<button class="action-btn" onclick="downloadInvoicePdf('${ord.id}')"><i class="fas fa-file-pdf"></i> Invoice PDF</button>` : ''}
                </div>
            </div>
            `;
        }
        function renderOrderDetailsKitchen(ord) {
            let html = '';
            if (ord.packages && ord.packages.length) {
                html += `<b>Package:</b><ul class="detailed-list">`;
                for (const pkg of ord.packages) {
                    const mi = menuItems.find(m => m.id === pkg.menuId);
                    if (mi) {
                        html += `<li><b>${mi.name} x${pkg.qty}</b>`;
                        if (menuDetails[mi.name]) {
                            html += `<ul class="detailed-list">${menuDetails[mi.name].map(i=>`<li>${i}</li>`).join('')}</ul>`;
                        }
                        html += `</li>`;
                    }
                }
                html += `</ul>`;
            }
            if (ord.alacarte && ord.alacarte.length) {
                html += `<b>Ala Carte:</b><ul class="detailed-list">`;
                for (const ac of ord.alacarte) {
                    const mi = menuItems.find(m => m.id === ac.menuId);
                    if (mi) {
                        html += `<li>${mi.name} x${ac.qty}</li>`;
                    }
                }
                html += `</ul>`;
            }
            return html;
        }
        function renderOrdersTable(tableId, orderArr, editable, showInvoice) {
            const tb = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tb.innerHTML = '';
            const sorted = orderArr.slice().sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
            for (const ord of sorted) {
                tb.innerHTML += `<tr>
                    <td>${ord.id}</td>
                    <td>${ord.customer}</td>
                    <td>${renderOrderDetails(ord)}</td>
                    <td>${formatDateTime(ord.deliveryTime)}</td>
                    <td>${formatStatus(ord.status)}</td>
                    <td><div class="order-history-log">${renderOrderHistory(ord)}</div></td>
                    ${editable ? `<td>
                        <div class="edit-cancel-btns">
                            <button class="btn btn-secondary" onclick="editOrder('${ord.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary" onclick="cancelOrder('${ord.id}')"><i class="fas fa-times"></i></button>
                        </div>
                    </td>` : ''}
                    ${showInvoice ? `<td>
                        <button class="btn btn-secondary" onclick="downloadInvoicePdf('${ord.id}')"><i class="fas fa-file-pdf"></i> Download</button>
                    </td>` : ''}
                </tr>`;
            }
        }
        function renderOrderDetails(ord) {
            let html = '';
            if (ord.packages && ord.packages.length) {
                html += `<b>Package:</b> <ul class="detailed-list">`;
                for (const pkg of ord.packages) {
                    const mi = menuItems.find(m => m.id === pkg.menuId);
                    if (mi) {
                        html += `<li><b>${mi.name} x${pkg.qty}</b>`;
                        if (menuDetails[mi.name]) {
                            html += `<ul class="detailed-list">${menuDetails[mi.name].map(i=>`<li>${i}</li>`).join('')}</ul>`;
                        }
                        html += `</li>`;
                    }
                }
                html += `</ul>`;
            }
            if (ord.alacarte && ord.alacarte.length) {
                html += `<b>Ala Carte:</b> <ul class="detailed-list">`;
                for (const ac of ord.alacarte) {
                    const mi = menuItems.find(m => m.id === ac.menuId);
                    if (mi) {
                        html += `<li>${mi.name} x${ac.qty}</li>`;
                    }
                }
                html += `</ul>`;
            }
            html += `<b>Notes:</b> ${ord.notes || '-'}`;
            return html;
        }
        function renderOrderHistory(ord) {
            const logs = [];
            if (ord.createdAt) logs.push(`Pending: ${formatDateTime(ord.createdAt)}`);
            if (ord.cookingAt) logs.push(`Cooking: ${formatDateTime(ord.cookingAt)}`);
            if (ord.readyAt) logs.push(`Ready: ${formatDateTime(ord.readyAt)}`);
            if (ord.completedAt) logs.push(`Completed: ${formatDateTime(ord.completedAt)}`);
            return logs.join('<br>');
        }

        // --- Edit Order Mode ---
        let editOrderMode = false;
        let editOrderId = null;
        let previousOrderData = null;
        function showEditModeBar(orderId) {
            document.getElementById('edit-mode-bar').style.display = 'flex';
            document.getElementById('edit-order-id-bar').innerText = orderId;
            document.getElementById('send-to-kitchen-btn').style.display = 'none';
            document.getElementById('floating-send-to-kitchen-btn').classList.add('hide');
            document.getElementById('order-form').querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        }
        function hideEditModeBar() {
            document.getElementById('edit-mode-bar').style.display = 'none';
            document.getElementById('send-to-kitchen-btn').style.display = '';
            editOrderMode = false;
            editOrderId = null;
            previousOrderData = null;
            document.getElementById('order-form').reset();
            setDefaultDeliveryTime();
            renderMenus();
            handleFloatingBtnVisibility();
        }
        window.editOrder = function(orderId) {
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return showNotification('Order not found!');
            if (ord.status !== "Pending") return showNotification('Order hanya bisa diedit saat status Pending!');
            editOrderMode = true;
            editOrderId = orderId;
            previousOrderData = JSON.parse(JSON.stringify(ord));
            showEditModeBar(orderId);
            document.getElementById('customer-name').value = ord.customer;
            document.getElementById('delivery-location').value = ord.deliveryLocation;
            document.getElementById('order-notes').value = ord.notes || '';
            let dtLocal = dayjs.utc(ord.deliveryTime).tz(DEFAULT_TZ).format('HH:mm');
            document.getElementById('delivery-time').value = dtLocal;
            for (const mi of menuItems.filter(m=>m.type==='package')) {
                const pkg = ord.packages.find(p=>p.menuId===mi.id);
                document.getElementById(`pkg_${mi.id}_qty`).value = pkg ? pkg.qty : 0;
                document.getElementById(`pkg_${mi.id}_qty_display`).innerText = pkg ? pkg.qty : 0;
            }
            for (const mi of menuItems.filter(m=>m.type==='alacarte')) {
                const ac = ord.alacarte.find(a=>a.menuId===mi.id);
                document.getElementById(`ac_${mi.id}_qty`).value = ac ? ac.qty : 0;
                document.getElementById(`ac_${mi.id}_qty_display`).innerText = ac ? ac.qty : 0;
            }
        };
        document.getElementById('edit-order-save-btn').onclick = async function() {
            if (!editOrderMode || !editOrderId) return;
            const customer = document.getElementById('customer-name').value.trim();
            const deliveryTimeInput = document.getElementById('delivery-time').value;
            const deliveryLocation = document.getElementById('delivery-location').value.trim();
            const notes = document.getElementById('order-notes').value.trim();
            const packages = [];
            for (const mi of menuItems.filter(m=>m.type==='package')) {
                const qty = Number(document.getElementById(`pkg_${mi.id}_qty`).value);
                if (qty > 0) packages.push({menuId: mi.id, qty});
            }
            const alacarte = [];
            for (const mi of menuItems.filter(m=>m.type==='alacarte')) {
                const qty = Number(document.getElementById(`ac_${mi.id}_qty`).value);
                if (qty > 0) alacarte.push({menuId: mi.id, qty});
            }
            if (!customer || !deliveryTimeInput || !deliveryLocation || (!packages.length && !alacarte.length)) {
                showNotification('Please fill all required fields and select items.');
                return;
            }
            const now = dayjs().tz(DEFAULT_TZ);
            const deliveryTime = dayjs.tz(`${now.format('YYYY-MM-DD')}T${deliveryTimeInput}`, DEFAULT_TZ).utc().toISOString();
            const order = {
                id: editOrderId,
                customer,
                deliveryTime: deliveryTime,
                deliveryLocation,
                notes,
                packages,
                alacarte,
                status: 'Pending',
                createdAt: previousOrderData.createdAt,
                kitchenNotes: previousOrderData.kitchenNotes || []
            };
            await db.collection('orders').doc(editOrderId).set(order);
            showNotification('Order edited successfully!');
            hideEditModeBar();
        };
        document.getElementById('edit-order-cancel-btn').onclick = function() {
            hideEditModeBar();
            showNotification('Edit cancelled, no changes applied.');
        };

        window.cancelOrder = function(orderId) {
            if (editOrderMode && editOrderId === orderId) {
                hideEditModeBar();
                showNotification('Edit cancelled, no changes applied.');
                return;
            }
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return showNotification('Order not found!');
            if (ord.status !== "Pending") return showNotification('Order hanya bisa dibatalkan saat status Pending!');
            db.collection('orders').doc(orderId).delete();
            showNotification('Order dibatalkan!');
        };

        function setDefaultDeliveryTime() {
            const input = document.getElementById('delivery-time');
            if (!input) return;
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            input.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }
        document.addEventListener('DOMContentLoaded', setDefaultDeliveryTime);

        document.getElementById('floating-send-to-kitchen-btn').onclick = function() {
            if (editOrderMode) return;
            showOrderSummaryModal();
        };
        function handleFloatingBtnVisibility() {
            var btn = document.getElementById('floating-send-to-kitchen-btn');
            var adminSectionActive = document.getElementById('admin-section').classList.contains('active');
            if (adminSectionActive && !editOrderMode) {
                btn.classList.remove('hide');
            } else {
                btn.classList.add('hide');
            }
        }
        document.addEventListener('DOMContentLoaded', handleFloatingBtnVisibility);

        // ---- MODAL ORDER SUMMARY PATCH ----
        function showOrderSummaryModal() {
            const customer = document.getElementById('customer-name').value.trim();
            const deliveryTimeInput = document.getElementById('delivery-time').value;
            const deliveryLocation = document.getElementById('delivery-location').value.trim();
            const notes = document.getElementById('order-notes').value.trim();
            const now = dayjs().tz(DEFAULT_TZ);
            const deliveryTime = dayjs.tz(`${now.format('YYYY-MM-DD')}T${deliveryTimeInput}`, DEFAULT_TZ).utc().toISOString();
            const packages = [];
            for (const mi of menuItems.filter(m=>m.type==='package')) {
                const qty = Number(document.getElementById(`pkg_${mi.id}_qty`).value);
                if (qty > 0) packages.push({menuId: mi.id, qty});
            }
            const alacarte = [];
            for (const mi of menuItems.filter(m=>m.type==='alacarte')) {
                const qty = Number(document.getElementById(`ac_${mi.id}_qty`).value);
                if (qty > 0) alacarte.push({menuId: mi.id, qty});
            }
            if (!customer || !deliveryTimeInput || !deliveryLocation || (!packages.length && !alacarte.length)) {
                showNotification('Please fill all required fields and select items.');
                return;
            }
            let html = `<b>NAMA:</b> ${customer}<br>`;
            html += `<b>ALAMAT:</b> ${deliveryLocation}<br>`;
            html += `<b>WAKTU ANTAR:</b> ${dayjs(deliveryTime).tz(DEFAULT_TZ).format('DD-MM-YYYY HH:mm')}<br><br>`;
            if (packages.length > 0) {
                html += `<b>MENU PAKET:</b><ul class="detailed-list">`;
                for (const pkg of packages) {
                    const mi = menuItems.find(m => m.id === pkg.menuId);
                    if (mi) {
                        html += `<li><b>${mi.name} x${pkg.qty}</b>`;
                        if (menuDetails[mi.name]) {
                            html += `<ul class="detailed-list">${menuDetails[mi.name].map(i=>`<li>${i}</li>`).join('')}</ul>`;
                        }
                        html += `</li>`;
                    }
                }
                html += `</ul>`;
            }
            if (alacarte.length > 0) {
                html += `<b>ALA CARTE:</b><ul class="detailed-list">`;
                for (const ac of alacarte) {
                    const mi = menuItems.find(m => m.id === ac.menuId);
                    if (mi) {
                        html += `<li>${mi.name} x${ac.qty}</li>`;
                    }
                }
                html += `</ul>`;
            }
            html += `<b>CATATAN:</b> ${notes || '-'}`;
            document.getElementById('modal-summary-details').innerHTML = html;
            document.getElementById('modal-summary-total').innerHTML = `<span>Total Pembayaran: <b>¥${calcOrderTotal({packages,alacarte})}</b></span>`;
            document.getElementById('order-summary-modal').style.display = 'flex';

            window.__orderSummaryTemp = {customer,deliveryTime,deliveryLocation,notes,packages,alacarte};
        }
        document.getElementById('modal-edit-btn').onclick = function() {
            document.getElementById('order-summary-modal').style.display = 'none';
        };
        document.getElementById('modal-send-btn').onclick = async function() {
            const temp = window.__orderSummaryTemp;
            if (!temp) return;
            const oid = `ORD_${Date.now().toString().slice(-8)}`;
            const order = {
                id: oid,
                customer: temp.customer,
                deliveryTime: temp.deliveryTime,
                deliveryLocation: temp.deliveryLocation,
                notes: temp.notes,
                packages: temp.packages,
                alacarte: temp.alacarte,
                status: 'Pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                kitchenNotes: []
            };
            await db.collection('orders').doc(oid).set(order);
            showNotification('Order sent to kitchen!');
            document.getElementById('order-form').reset();
            setDefaultDeliveryTime();
            renderMenus();
            document.getElementById('order-summary-modal').style.display = 'none';
        };
        document.getElementById('order-summary-modal').onclick = function(e) {
            if (e.target === this) this.style.display = 'none';
        };

        document.getElementById('order-form').onsubmit = function(e) {
            e.preventDefault();
            if (editOrderMode) return;
            showOrderSummaryModal();
        };

        window.handleKitchenAction = async function(orderId, newStatus, btn) {
            btn.classList.add('pop');
            setTimeout(()=>btn.classList.remove('pop'), 370);
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return;
            let updateObj = { status: newStatus };
            updateObj[`${newStatus.toLowerCase()}At`] = firebase.firestore.FieldValue.serverTimestamp();
            if (newStatus === 'Completed') {
                updateObj.completedAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            await db.collection('orders').doc(orderId).update(updateObj);
            showNotification(`Order ${orderId} status updated to ${newStatus}`);
            if (newStatus === "Ready") {
                sendTelegram(orderId);
            }
        };

        document.getElementById('export-excel-btn').onclick = function() {
            let start = document.getElementById('report-start').value;
            let end = document.getElementById('report-end').value;
            let type = document.getElementById('report-type').value;
            let filtered = orders.filter(ord => {
                let t = ord.createdAt && ord.createdAt.seconds ? dayjs.unix(ord.createdAt.seconds).tz(DEFAULT_TZ).toDate() : new Date(ord.createdAt);
                let s = start ? new Date(start) : null;
                let e = end ? new Date(end) : null;
                return (!s || t >= s) && (!e || t <= e);
            });
            let data = filtered.map(ord => ({
                "Order ID": ord.id,
                "Date": formatDateTime(ord.createdAt),
                "Customer": ord.customer,
                "Order Details": 
                    "Package: " + ord.packages.map(p => {
                        const mi = menuItems.find(m => m.id === p.menuId); 
                        return mi ? `${mi.name} x${p.qty}` : '';
                    }).join(', ') +
                    "; Ala Carte: " + ord.alacarte.map(a => {
                        const mi = menuItems.find(m => m.id === a.menuId);
                        return mi ? `${mi.name} x${a.qty}` : '';
                    }).join(', '),
                "Status": ord.status,
                "Delivery Time": formatDateTime(ord.deliveryTime),
                "Timestamp Pending": formatDateTime(ord.createdAt),
                "Timestamp Cooking": formatDateTime(ord.cookingAt),
                "Timestamp Ready": formatDateTime(ord.readyAt),
                "Timestamp Completed": formatDateTime(ord.completedAt)
            }));
            let ws = XLSX.utils.json_to_sheet(data);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            let filename = autoFileNameReport(type, start, end);
            XLSX.writeFile(wb, filename);
            showNotification('Excel report exported!');
        };

        function generateInvoice(orderId) {
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return;
            const total = calcOrderTotal(ord);
            const invoiceId = `INV_${orderId}`;
            const invoice = {
                invoiceId,
                orderId,
                customer: ord.customer,
                totalPrice: total,
                completedTime: ord.completedAt || new Date(),
                details: {
                    packages: ord.packages,
                    alacarte: ord.alacarte
                }
            };
            invoices.unshift(invoice);
            renderInvoicesTable();
        }
        function renderInvoicesTable() {
            const tb = document.getElementById('invoices-table').getElementsByTagName('tbody')[0];
            tb.innerHTML = '';
            for (const inv of invoices) {
                tb.innerHTML += `<tr>
                    <td>${inv.invoiceId}</td>
                    <td>${inv.orderId}</td>
                    <td>${inv.customer}</td>
                    <td>¥${inv.totalPrice}</td>
                    <td>${formatDateTime(inv.completedTime)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="downloadInvoicePdf('${inv.orderId}')"><i class="fas fa-file-pdf"></i> Download</button>
                    </td>
                </tr>`;
            }
        }
        window.downloadInvoicePdf = function(orderId) {
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return showNotification('Order not found!');
            const total = calcOrderTotal(ord);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('helvetica','bold');
            doc.setFontSize(18);
            doc.text('CRI Invoice', 20, 20);
            doc.setFontSize(12);
            doc.setFont('helvetica','normal');
            doc.text(`Invoice ID: INV_${orderId}`, 20, 30);
            doc.text(`Customer: ${ord.customer}`, 20, 38);
            doc.text(`Delivery Location: ${ord.deliveryLocation}`, 20, 46);
            doc.text(`Delivery Time: ${formatDateTime(ord.deliveryTime)}`, 20, 54);
            doc.text(`Completed: ${formatDateTime(ord.completedAt)}`, 20, 62);
            doc.text('Order Details:', 20, 70);
            let y = 78;
            for (const pkg of ord.packages) {
                const mi = menuItems.find(m => m.id === pkg.menuId);
                if (mi) {
                    doc.text(`Package: ${mi.name} x${pkg.qty} @¥${mi.price}`, 25, y);
                    y += 8;
                    if (menuDetails[mi.name]) {
                        for (const detail of menuDetails[mi.name]) {
                            doc.text(`- ${detail}`, 30, y);
                            y += 6;
                        }
                    }
                }
            }
            for (const ac of ord.alacarte) {
                const mi = menuItems.find(m => m.id === ac.menuId);
                if (mi) {
                    doc.text(`Ala Carte: ${mi.name} x${ac.qty} @¥${mi.price}`, 25, y);
                    y += 8;
                }
            }
            doc.text(`Total Price: ¥${total}`, 20, y+5);
            doc.save(`invoice_${orderId}.pdf`);
            showNotification('Invoice downloaded!');
        };

        function sendTelegram(orderId) {
            if (telegramSentIds.has(orderId)) return;
            const ord = orders.find(o => o.id === orderId);
            if (!ord) return;
            let msg = '👋🏻 Siap Diantar 👋🏻\n\n';
            msg += `Orderan #${ord.id}\n\n`;
            msg += `Nama: ${ord.customer}\nAlamat: ${ord.deliveryLocation}\nWaktu Antar: ${formatDateTime(ord.deliveryTime)}\n\n`;
            msg += `Pesanan:\n`;
            for (const pkg of ord.packages) {
                const mi = menuItems.find(m => m.id === pkg.menuId);
                if (mi) {
                    msg += `- ${mi.name} x${pkg.qty}\n`;
                    if (menuDetails[mi.name]) {
                        for (const detail of menuDetails[mi.name]) {
                            msg += `   • ${detail}\n`;
                        }
                    }
                }
            }
            for (const ac of ord.alacarte) {
                const mi = menuItems.find(m => m.id === ac.menuId);
                if (mi) {
                    msg += `- ${mi.name} x${ac.qty}\n`;
                }
            }
            msg += `Catatan: ${ord.notes || '-'}\n\n`;
            msg += `Total Bayar: ¥${calcOrderTotal(ord)}\n`;
            const botToken = "7977280306:AAFG8qAVnSD81p73iFP3wRceOP-605auqQ0";
            const chatId = "-1002880911209";
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `chat_id=${encodeURIComponent(chatId)}&text=${encodeURIComponent(msg)}`
            }).then(r=>r.json()).then(data=>{
                if (data.ok) {
                    telegramSentIds.add(orderId);
                    showNotification('Pesan Telegram sukses!');
                } else {
                    showNotification('Gagal kirim Telegram: ' + JSON.stringify(data));
                }
            }).catch(e=>{
                showNotification('Gagal kirim Telegram: ' + e.message);
            });
        }

        db.collection('menu').onSnapshot(snap => {
            menuItems = snap.docs.map(doc => doc.data());
            renderMenus();
            renderMenuTable();
        });
        db.collection('orders').onSnapshot(snap => {
            orders = snap.docs.map(doc => doc.data());
            renderAdminOrders();
            renderKitchenOrders();
        });
        db.collection('invoices').onSnapshot(snap => {
            invoices = snap.docs.map(doc => doc.data());
            renderInvoicesTable();
        });

        function initialLoad() {
            renderMenus();
            renderMenuTable();
            renderAdminOrders();
            renderKitchenOrders();
            renderInvoicesTable();
            handleFloatingBtnVisibility();
        }
        initialLoad();
    </script>
</body>
</html>
